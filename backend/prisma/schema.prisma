// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ────────────────────────────────
// ENUMS
// ────────────────────────────────

enum Role {
  ADMIN
  MAYOR
  VIEWER
}

// ────────────────────────────────
// MODELS
// ────────────────────────────────

model User {
  id          Int       @id @default(autoincrement())
  firstName   String
  lastName    String
  username    String    @unique
  email       String    @unique
  password    String
  role        Role

  // Relation to City (only for MAYORs)
  city        City?     @relation(name: "CityMayor")

  // ────────────────
  // New Mayor–Viewer relationship
  // ────────────────
  mayorId     Int?                               // only for VIEWERs
  mayor       User?     @relation("MayorViewers", fields: [mayorId], references: [id], onDelete: Cascade)
  viewers     User[]    @relation("MayorViewers") // all Viewers assigned to this Mayor

  notes       Note[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model City {
  id           Int       @id @default(autoincrement())
  name         String
  country      String
  qualityIndex Float     @default(0)
  buildingLog  Json?
  gridState    Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  mayor        User      @relation(fields: [mayorId], references: [id], name: "CityMayor")
  mayorId      Int       @unique
  buildLogs    BuildLog[]
  buildings    Building[]
}

model BuildLog {
  id        Int      @id @default(autoincrement())
  cityId    Int
  action    String
  value     Int?
  createdAt DateTime @default(now())

  city      City     @relation(fields: [cityId], references: [id])
}

model Note {
  id        Int      @id @default(autoincrement())
  userId    Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

model BuildingCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())

  buildings   Building[]
}

model Building {
  id             Int                 @id @default(autoincrement())
  cityId         Int?                
  name           String
  categoryId     Int?
  level          Int                 @default(1)
  sizeX          Int                 @default(1)
  sizeY          Int                 @default(1)
  powerUsage     Int                 @default(0)
  powerOutput    Int                 @default(0)
  waterUsage     Int                 @default(0)
  waterOutput    Int                 @default(0)
  createdAt      DateTime            @default(now())

  city           City?               @relation(fields: [cityId], references: [id])
  category       BuildingCategory?   @relation(fields: [categoryId], references: [id])
  resources      BuildingResource[]
}

model BuildingResource {
  id         Int      @id @default(autoincrement())
  buildingId Int
  type       String
  amount     Int      @default(0)
  createdAt  DateTime @default(now())

  building   Building @relation(fields: [buildingId], references: [id])
}
