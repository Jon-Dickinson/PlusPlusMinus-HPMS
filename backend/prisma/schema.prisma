// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ────────────────────────────────
// ENUMS
// ────────────────────────────────

enum Role {
  ADMIN
  MAYOR
  VIEWER
}

// ────────────────────────────────
// MODELS
// ────────────────────────────────

model User {
  id          Int       @id @default(autoincrement())
  firstName   String
  lastName    String
  username    String    @unique
  email       String    @unique
  password    String
  role        Role

  // Hierarchical assignment
  hierarchyId Int?
  hierarchy   HierarchyLevel? @relation(fields: [hierarchyId], references: [id])

  // Building permissions
  permissions UserPermission[]

  // Relation to City (only for MAYORs) - keeping for backward compatibility
  city        City?     @relation(name: "CityMayor")

  // ────────────────
  // New Mayor–Viewer relationship - keeping for backward compatibility
  // ────────────────
  mayorId     Int?                               // only for VIEWERs
  mayor       User?     @relation("MayorViewers", fields: [mayorId], references: [id], onDelete: Cascade)
  viewers     User[]    @relation("MayorViewers") // all Viewers assigned to this Mayor

  notes       Note[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model City {
  id           Int       @id @default(autoincrement())
  name         String
  country      String
  qualityIndex Float     @default(0)
  buildingLog  Json?
  gridState    Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  mayor        User      @relation(fields: [mayorId], references: [id], name: "CityMayor")
  mayorId      Int       @unique
  buildLogs    BuildLog[]
  buildings    Building[]
  // Relation to quality index audit entries
  qualityIndexAudits QualityIndexAudit[]
}

// Audit table for recording qualityIndex changes to Cities
model QualityIndexAudit {
  id        Int      @id @default(autoincrement())
  cityId    Int
  oldValue  Float
  newValue  Float
  reason    String?  // e.g. "recompute:generator-update"
  createdAt DateTime @default(now())

  city      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
}

model BuildLog {
  id        Int      @id @default(autoincrement())
  cityId    Int
  action    String
  value     Int?
  createdAt DateTime @default(now())

  city      City     @relation(fields: [cityId], references: [id])
}

model Note {
  id        Int      @id @default(autoincrement())
  userId    Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

model HierarchyLevel {
  id        Int @id @default(autoincrement())
  name      String           // "National", "City", "Suburb"
  level     Int              // 1, 2, 3 (hierarchy depth)
  parentId  Int?
  parent    HierarchyLevel? @relation("HierarchyTree", fields: [parentId], references: [id])
  children  HierarchyLevel[] @relation("HierarchyTree")
  users     User[]
  createdAt DateTime @default(now())
}

model UserPermission {
  id          Int @id @default(autoincrement())
  userId      Int
  categoryId  Int
  canBuild    Boolean @default(false)
  user        User @relation(fields: [userId], references: [id])
  category    BuildingCategory @relation(fields: [categoryId], references: [id])
  createdAt   DateTime @default(now())

  @@unique([userId, categoryId])
}

model BuildingCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())

  buildings   Building[]
  permissions UserPermission[]
}

model Building {
  id             Int                 @id @default(autoincrement())
  cityId         Int?                
  name           String
  categoryId     Int?
  level          Int                 @default(1)
  sizeX          Int                 @default(1)
  sizeY          Int                 @default(1)
  powerUsage     Int                 @default(0)
  powerOutput    Int                 @default(0)
  waterUsage     Int                 @default(0)
  waterOutput    Int                 @default(0)
  createdAt      DateTime            @default(now())

  city           City?               @relation(fields: [cityId], references: [id])
  category       BuildingCategory?   @relation(fields: [categoryId], references: [id])
  resources      BuildingResource[]
}

model BuildingResource {
  id         Int      @id @default(autoincrement())
  buildingId Int
  type       String
  amount     Int      @default(0)
  createdAt  DateTime @default(now())

  building   Building @relation(fields: [buildingId], references: [id])
}

// Audit log for permission queries — used to trace permission checks / queries
model PermissionQueryAudit {
  id             Int      @id @default(autoincrement())
  callerId       Int?     // user id who requested the permission check
  callerRole     String?  // role snapshot for caller
  targetUserId   Int?     // user being checked (if applicable)
  targetRole     String?  // role snapshot for target user
  categoryId     Int?     // building category id (if applicable)
  endpoint       String   // endpoint path or action name
  action         String   // e.g. EFFECTIVE_PERMISSIONS, ALLOWED_BUILDINGS, SUBORDINATES
  input          Json?    // sanitized input / params (avoid PII)
  decision       String   // ALLOWED | DENIED | NOT_APPLICABLE
  reason         String?  // optional short reason/cause
  result         Json?    // small result summary (optional)
  durationMs     Int?     // timing for query
  ip             String?  // optional caller ip
  userAgent      String?  // optional user agent
  requestId      String?  // correlates with request logs
  createdAt      DateTime @default(now())

  @@index([callerId])
  @@index([targetUserId])
  @@index([endpoint, createdAt])
}
