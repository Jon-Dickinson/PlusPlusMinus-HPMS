{
  "openapi": "3.0.1",
  "info": {
    "title": "PlusPlusMinus HPMS API",
    "version": "2.0.0",
    "description": "Hierarchical Permission Management System API for City Builder with role-based building access"
  },
  "servers": [
    { "url": "https://passionate-contentment-production.up.railway.app", "description": "Production (Railway)" },
    { "url": "http://localhost:4000", "description": "Local Development" }
  ],
  "security": [{ "bearerAuth": [] }],
  "tags": [
    {
      "name": "Authentication",
      "description": "User registration and login endpoints"
    },
    {
      "name": "Buildings",
      "description": "Building types and city placement management"
    },
    {
      "name": "Cities",
      "description": "City management and data operations"
    },
    {
      "name": "Hierarchy",
      "description": "Hierarchical permission system endpoints"
    },
    {
      "name": "Notes",
      "description": "User notes management"
    },
    {
      "name": "Public",
      "description": "Public endpoints that don't require authentication"
    },
    {
      "name": "Users",
      "description": "User management endpoints"
    }
  ],
  "paths": {
    "/auth/register": {
      "post": {
        "summary": "Register new user (public)",
        "tags": ["Authentication"],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/RegisterRequest" } }
          }
        },
        "responses": {
          "201": { "description": "Created" },
          "400": { "description": "Validation failed" }
        }
      }
    },
    "/auth/login": {
      "post": {
        "summary": "Login (public)",
        "tags": ["Authentication"],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/LoginRequest" } }
          }
        },
        "responses": {
          "200": { "description": "OK" },
          "401": { "description": "Invalid credentials" }
        }
      }
    },
    "/buildings": {
      "get": {
        "summary": "List building types",
        "tags": ["Buildings"],
        "responses": {
          "200": { "description": "List of buildings" }
        }
      },
      "post": {
        "summary": "Create building (admin)",
        "tags": ["Buildings"],
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/BuildingCreate" } }
          }
        },
        "responses": {
          "201": { "description": "Created" },
          "400": { "description": "Validation failed" }
        }
      }
    },
    "/buildings/{id}": {
      "get": {
        "summary": "Get building",
        "tags": ["Buildings"],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": { "200": { "description": "Building" }, "404": { "description": "Not found" } }
      },
      "patch": {
        "summary": "Update building (admin)",
        "tags": ["Buildings"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/BuildingUpdate" } }
          }
        },
        "responses": { "200": { "description": "Updated" } }
      },
      "delete": {
        "summary": "Delete building (admin)",
        "tags": ["Buildings"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": { "204": { "description": "Deleted" } }
      }
    },
    "/buildings/cities/{cityId}": {
      "get": {
        "summary": "List placed buildings in a city",
        "tags": ["Buildings"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "cityId", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": { "200": { "description": "List" } }
      },
      "post": {
        "summary": "Place building in city",
        "tags": ["Buildings"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "cityId", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/CityPlacementCreate" } }
          }
        },
        "responses": { "201": { "description": "Created" } }
      }
    },
    "/buildings/cities/{cityId}/{id}": {
      "patch": {
        "summary": "Update city placement",
        "tags": ["Buildings"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "cityId", "in": "path", "required": true, "schema": { "type": "integer" } },
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/CityPlacementCreate" } }
          }
        },
        "responses": { "200": { "description": "Updated" } }
      },
      "delete": {
        "summary": "Delete city placement",
        "tags": ["Buildings"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "cityId", "in": "path", "required": true, "schema": { "type": "integer" } },
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": { "204": { "description": "Deleted" } }
      }
    },
    "/hierarchy/tree": {
      "get": {
        "summary": "Get complete hierarchy tree structure",
        "description": "Returns the full organizational hierarchy with all levels, children, and assigned users",
        "tags": ["Hierarchy"],
        "security": [{ "bearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Hierarchy tree structure",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/HierarchyLevel" }
                }
              }
            }
          },
          "401": { "description": "Unauthorized" }
        }
      }
    },
    "/hierarchy/buildings/allowed/{userId}": {
      "get": {
        "summary": "Get buildings a user can build",
        "description": "Returns building categories and buildings that the specified user has permission to build based on their hierarchy level",
        "tags": ["Hierarchy", "Buildings"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" },
            "description": "ID of the user to check permissions for"
          }
        ],
        "responses": {
          "200": {
            "description": "Allowed buildings by category",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/AllowedBuildingCategory" }
                }
              }
            }
          },
          "401": { "description": "Unauthorized" },
          "404": { "description": "User not found" }
        }
      }
    },
    "/hierarchy/users/subordinates/{userId}": {
      "get": {
        "summary": "Get subordinate users in hierarchy",
        "description": "Returns all users that are subordinate to the specified user in the organizational hierarchy (same level and below)",
        "tags": ["Hierarchy", "Users"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" },
            "description": "ID of the user to get subordinates for"
          }
        ],
        "responses": {
          "200": {
            "description": "List of subordinate users",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/HierarchyUser" }
                }
              }
            }
          },
          "401": { "description": "Unauthorized" },
          "404": { "description": "User not found" }
        }
      }
    },
    "/users": {
      "get": {
        "summary": "List all users",
        "description": "Get list of all users in the system (admin only)",
        "tags": ["Users"],
        "security": [{ "bearerAuth": [] }],
        "responses": {
          "200": {
            "description": "List of users",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/HierarchyUser" }
                }
              }
            }
          },
          "401": { "description": "Unauthorized" },
          "403": { "description": "Forbidden - Admin access required" }
        }
      }
    },
    "/users/{id}": {
      "get": {
        "summary": "Get user by ID",
        "tags": ["Users"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "User details",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/HierarchyUser" }
              }
            }
          },
          "401": { "description": "Unauthorized" },
          "404": { "description": "User not found" }
        }
      }
    },
    "/cities": {
      "get": {
        "summary": "List all cities",
        "tags": ["Cities"],
        "responses": {
          "200": {
            "description": "List of cities",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/City" }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Create new city",
        "tags": ["Cities"],
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/CityCreate" } }
          }
        },
        "responses": {
          "201": { "description": "City created" }
        }
      }
    },
    "/cities/{id}": {
      "get": {
        "summary": "Get city by ID",
        "tags": ["Cities"],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "City details",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/City" } }
            }
          },
          "404": { "description": "City not found" }
        }
      },
      "put": {
        "summary": "Update city",
        "tags": ["Cities"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/CityUpdate" } }
          }
        },
        "responses": { "200": { "description": "City updated" } }
      },
      "delete": {
        "summary": "Delete city",
        "tags": ["Cities"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": { "204": { "description": "City deleted" } }
      }
    },
    "/cities/{id}/data": {
      "get": {
        "summary": "Get city grid and building data",
        "tags": ["Cities"],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "City grid data and buildings",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/CityData" } }
            }
          }
        }
      },
      "put": {
        "summary": "Update city data (grid state, buildings)",
        "tags": ["Cities"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/CityDataUpdate" } }
          }
        },
        "responses": { "200": { "description": "City data updated" } }
      }
    },
    "/cities/user/{userId}": {
      "get": {
        "summary": "Get city by user/mayor ID",
        "tags": ["Cities"],
        "parameters": [
          { "name": "userId", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "User's city",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/City" } }
            }
          },
          "404": { "description": "City not found for user" }
        }
      }
    },
    "/cities/user/{userId}/save": {
      "put": {
        "summary": "Save city by user ID (admin or owner only)",
        "tags": ["Cities"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "userId", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/CityDataUpdate" } }
          }
        },
        "responses": { "200": { "description": "City saved" } }
      }
    },
    "/cities/{id}/logs": {
      "get": {
        "summary": "Get city build logs",
        "tags": ["Cities"],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": { "200": { "description": "Build logs" } }
      },
      "post": {
        "summary": "Add build log entry",
        "tags": ["Cities"],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/BuildLog" } }
          }
        },
        "responses": { "201": { "description": "Log entry added" } }
      }
    },
    "/cities/{id}/notes": {
      "get": {
        "summary": "Get city notes",
        "tags": ["Cities"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": { "200": { "description": "City notes" } }
      },
      "post": {
        "summary": "Add city note",
        "tags": ["Cities"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/Note" } }
          }
        },
        "responses": { "201": { "description": "Note added" } }
      }
    },
    "/notes/{userId}": {
      "get": {
        "summary": "Get user notes",
        "tags": ["Notes"],
        "parameters": [
          { "name": "userId", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": { "200": { "description": "User notes" } }
      },
      "put": {
        "summary": "Save user note (admin or owner only)",
        "tags": ["Notes"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "userId", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "content": {
            "application/json": { "schema": { "$ref": "#/components/schemas/Note" } }
          }
        },
        "responses": { "200": { "description": "Note saved" } }
      }
    },
    "/public/mayors": {
      "get": {
        "summary": "List all mayors (public endpoint)",
        "tags": ["Public"],
        "security": [],
        "responses": {
          "200": {
            "description": "List of mayors",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/BasicUser" }
                }
              }
            }
          }
        }
      }
    },
    "/hierarchy/test": {
      "get": {
        "summary": "Test hierarchy routes deployment",
        "tags": ["Hierarchy"],
        "security": [],
        "responses": {
          "200": {
            "description": "Test response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": { "type": "string" },
                    "timestamp": { "type": "string", "format": "date-time" }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "Building": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "name": { "type": "string" },
          "file": { "type": "string" },
          "category": { "type": "string" },
          "footprint": {
            "type": "object",
            "properties": { "width": { "type": "integer" }, "height": { "type": "integer" } }
          },
          "stats": { "type": "object" }
        }
      },
      "BuildingCreate": {
        "type": "object",
        "required": ["name", "sizeX", "sizeY", "blocks"],
        "properties": {
          "name": { "type": "string" },
          "file": { "type": "string" },
          "categoryId": { "type": "integer" },
          "categoryName": { "type": "string" },
          "sizeX": { "type": "integer" },
          "sizeY": { "type": "integer" },
          "blocks": { "type": "integer" },
          "employs": { "type": "integer" },
          "houses": { "type": "integer" }
        }
      },
      "BuildingUpdate": {
        "allOf": [{ "$ref": "#/components/schemas/BuildingCreate" }],
        "additionalProperties": true
      },
      "CityPlacementCreate": {
        "type": "object",
        "required": ["buildingId"],
        "properties": {
          "buildingId": { "type": "integer" },
          "gx": { "type": "integer" },
          "gy": { "type": "integer" },
          "quantity": { "type": "integer" }
        }
      }
    },
    "RegisterRequest": {
      "type": "object",
      "required": ["name", "email", "password"],
      "properties": {
        "name": { "type": "string" },
        "email": { "type": "string", "format": "email" },
        "password": { "type": "string" }
      }
    },
    "LoginRequest": {
      "type": "object",
      "required": ["email", "password"],
      "properties": {
        "email": { "type": "string", "format": "email" },
        "password": { "type": "string" }
      }
    },
    "AuthResponse": {
      "type": "object",
      "properties": {
        "token": { "type": "string" },
        "user": { "$ref": "#/components/schemas/Building" }
      }
    },
    "HierarchyLevel": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "name": { "type": "string", "description": "Level name (e.g., 'National', 'City A', 'Suburb A1')" },
        "level": { "type": "integer", "description": "Hierarchy depth (1=National, 2=City, 3=Suburb)" },
        "parentId": { "type": "integer", "nullable": true, "description": "ID of parent level" },
        "createdAt": { "type": "string", "format": "date-time" },
        "children": {
          "type": "array",
          "items": { "$ref": "#/components/schemas/HierarchyLevel" },
          "description": "Child hierarchy levels"
        },
        "users": {
          "type": "array",
          "items": { "$ref": "#/components/schemas/BasicUser" },
          "description": "Users assigned to this hierarchy level"
        }
      }
    },
    "BasicUser": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "firstName": { "type": "string" },
        "lastName": { "type": "string" },
        "username": { "type": "string" },
        "role": { 
          "type": "string", 
          "enum": ["ADMIN", "MAYOR", "VIEWER"],
          "description": "User role: ADMIN (all permissions), MAYOR (hierarchy-based permissions), VIEWER (read-only)"
        }
      }
    },
    "HierarchyUser": {
      "allOf": [
        { "$ref": "#/components/schemas/BasicUser" },
        {
          "type": "object",
          "properties": {
            "email": { "type": "string", "format": "email" },
            "hierarchy": {
              "type": "object",
              "properties": {
                "id": { "type": "integer" },
                "name": { "type": "string" },
                "level": { "type": "integer" }
              }
            }
          }
        }
      ]
    },
    "AllowedBuildingCategory": {
      "type": "object",
      "properties": {
        "categoryId": { "type": "integer" },
        "categoryName": { "type": "string", "description": "Building category name (e.g., 'Residential', 'Commercial')" },
        "description": { "type": "string", "nullable": true },
        "buildings": {
          "type": "array",
          "items": { "$ref": "#/components/schemas/BuildingDetails" },
          "description": "Buildings in this category that the user can build"
        }
      }
    },
    "BuildingDetails": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "name": { "type": "string" },
        "level": { "type": "integer", "description": "Building level/tier" },
        "sizeX": { "type": "integer", "description": "Grid width" },
        "sizeY": { "type": "integer", "description": "Grid height" },
        "powerUsage": { "type": "integer", "description": "Power consumption" },
        "powerOutput": { "type": "integer", "description": "Power generation" },
        "waterUsage": { "type": "integer", "description": "Water consumption" },
        "waterOutput": { "type": "integer", "description": "Water generation" }
      }
    },
    "PermissionMatrix": {
      "type": "object",
      "description": "Building permissions by hierarchy level",
      "properties": {
        "National": {
          "type": "array",
          "items": { "type": "string" },
          "example": ["Infrastructure", "Commercial", "Services", "Residential", "Agriculture", "Emergency", "Government"],
          "description": "National level mayors can build all building categories"
        },
        "City": {
          "type": "array", 
          "items": { "type": "string" },
          "example": ["Infrastructure", "Commercial", "Services", "Residential", "Agriculture"],
          "description": "City level mayors can build most categories except specialized ones"
        },
        "Suburb": {
          "type": "array",
          "items": { "type": "string" },
          "example": ["Residential", "Agriculture"],
          "description": "Suburb level mayors can only build basic residential and agricultural buildings"
        }
      }
    },
    "City": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "name": { "type": "string" },
        "country": { "type": "string" },
        "mayorId": { "type": "integer" },
        "gridSize": { "type": "integer", "description": "City grid size (e.g., 50 for 50x50)" },
        "gridState": { "type": "string", "description": "JSON string of city grid data" },
        "buildingLog": { "type": "string", "description": "JSON string of building placement history" },
        "qualityIndex": { "type": "integer", "description": "City quality percentage (0-100)" },
        "createdAt": { "type": "string", "format": "date-time" },
        "updatedAt": { "type": "string", "format": "date-time" }
      }
    },
    "CityCreate": {
      "type": "object",
      "required": ["name", "country", "mayorId"],
      "properties": {
        "name": { "type": "string" },
        "country": { "type": "string" },
        "mayorId": { "type": "integer" },
        "gridSize": { "type": "integer", "default": 50 }
      }
    },
    "CityUpdate": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "country": { "type": "string" },
        "mayorId": { "type": "integer" },
        "gridSize": { "type": "integer" }
      }
    },
    "CityData": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "name": { "type": "string" },
        "gridSize": { "type": "integer" },
        "gridState": { 
          "type": "object",
          "description": "Parsed city grid with building placements"
        },
        "buildingLog": {
          "type": "array",
          "items": { "$ref": "#/components/schemas/BuildLogEntry" },
          "description": "Parsed building placement history"
        },
        "qualityIndex": { "type": "integer" }
      }
    },
    "CityDataUpdate": {
      "type": "object",
      "properties": {
        "gridState": { "type": "string", "description": "JSON string of updated grid state" },
        "buildingLog": { "type": "string", "description": "JSON string of updated building log" },
        "qualityIndex": { "type": "integer" }
      }
    },
    "BuildLog": {
      "type": "object",
      "required": ["action"],
      "properties": {
        "action": { "type": "string", "description": "Build action description" },
        "value": { "type": "number", "description": "Optional numeric value" }
      }
    },
    "BuildLogEntry": {
      "type": "object",
      "properties": {
        "action": { "type": "string" },
        "value": { "type": "number" },
        "timestamp": { "type": "string", "format": "date-time" }
      }
    },
    "Note": {
      "type": "object",
      "required": ["content"],
      "properties": {
        "id": { "type": "integer" },
        "content": { "type": "string", "minLength": 1 },
        "userId": { "type": "integer" },
        "cityId": { "type": "integer" },
        "createdAt": { "type": "string", "format": "date-time" }
      }
    },
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Enter your JWT Bearer token in the format: Bearer <token>"
      }
    }
  }
}
